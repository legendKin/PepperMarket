<!doctype html>
<html
  lang="en"
  layout:decorate="~{layouts/chatlayout}"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  xmlns:th="http://www.thymeleaf.org"
>
  <head>
    <meta charset="UTF-8" />
    <title>Chat Room</title>
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/chat_page.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.4.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  </head>
  <body>
    <div layout:fragment="chat-content">
      <div class="chat-msg-container row row-cols-1">
        <div class="col chat-receiver" id="chatroom-detail"></div>
        <div class="col chat-msg" id="msgArea" style="height: 50vh">
          <!-- 채팅 내용이 여기에 표시됩니다 -->
        </div>
        <div class="col chat-input">
          <div class="input-group mb-3">
            <input
              aria-describedby="button-addon2"
              class="messageInput"
              id="msg"
              type="text"
              placeholder="메세지를 입력해주세요."
            />
            <div class="input-group-append">
              <button
                class="btn btn-outline-secondary sendButton"
                id="button-send"
                type="button"
              >
                전송
              </button>
            </div>
          </div>
        </div>
      </div>

      <script th:inline="javascript">
        $(document).ready(function () {
          const userId = /*[[${#authentication.principal.id}]]*/ "anonymous"; // 로그인한 사용자의 ID
          const chatRoomId = /*[[${chatRoomId}]]*/ "defaultRoom"; // 채팅방 ID
          const receiverId = /*[[${receiverId}]]*/ "defaultReceiver"; // 수신자 ID

          function displayMessage(message) {
            var senderName = message.sender.nickname; // 보낸 사람의 닉네임
            var timestamp = new Date(message.timestamp);
            var options = {
              hour: "2-digit",
              minute: "2-digit",
              timeZone: "Asia/Seoul",
            };
            var formattedTime = timestamp.toLocaleTimeString("ko-KR", options);

            // 로그인된 사용자의 닉네임
            // 여기에 실제 로그인된 사용자의 닉네임을 설정

            // 메시지를 렌더링할 위치를 결정
            var fromWhoBox =
              message.sender.id === userId ? "from-me" : "from-partner";
            var fromWhoMsg =
              message.sender.id === userId ? "from-me-box" : "from-partner-box";
            var name = message.sender.id === userId ? "" : senderName;

            var str = "<div class='col msg-box " + fromWhoBox + "'>";
            str += "<div class  = 'sender'>" + name + "</div>";
            str += "<div class='msg " + fromWhoMsg + "'>";
            str += message.content;
            str += "</div>";
            str += "<div class='msg-time'>" + formattedTime + "</div>";
            str += "</div>";

            $("#msgArea").append(str);
            // 스크롤을 맨 아래로 이동
            $("#msgArea").scrollTop($("#msgArea")[0].scrollHeight);
          }

          function loadCurrentChatRoomInfo(chatRoomId) {
            $.ajax({
              type: "GET",
              url: `/chat/chatRoom/${chatRoomId}`,
              success: function (chatRoomInfo) {
                // 성공적으로 채팅방 정보를 받아왔을 때 실행되는 코드
                // 받은 정보를 사용하여 채팅방의 세부 정보를 표시
                $("#chatroom-detail").html(`
                <div class="chat-room-detail">
                    <h3>${chatRoomInfo.partnerName}님과의 채팅</h3>
                    <p>게시글: <a href="/board/view?id=${chatRoomInfo.postId}">${chatRoomInfo.postTitle}</a></p>
                </div>
            `);
              },
              error: function (error) {
                // AJAX 요청이 실패했을 때 실행되는 코드
                console.error("채팅방 정보 로딩 중 오류 발생:", error);
              },
            });
          }

          function getPreviousChatMessages(chatRoomId) {
            fetch("/chat/messages/" + chatRoomId)
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((messages) => {
                if (Array.isArray(messages)) {
                  messages.forEach(displayMessage);
                } else {
                  throw new Error("Invalid response format");
                }
              })
              .catch((error) => {
                console.error(
                  "There has been a problem with your fetch operation:",
                  error,
                );
              });
          }

          getPreviousChatMessages(chatRoomId);

          $("#button-send").on("click", (e) => {
            send();
          });

          const socket = new SockJS("/ws/chat");
          const stompClient = Stomp.over(socket);

          stompClient.connect({}, function (frame) {
            console.log("Connected: " + frame);

            stompClient.subscribe("/topic/public", function (messageOutput) {
              const message = JSON.parse(messageOutput.body);
              displayMessage(message);
            });
          });

          function send() {
            const messageContent = document.getElementById("msg").value.trim();

            if (messageContent === "") {
              return; // 메시지가 비어있으면 함수를 종료하여 전송하지 않음
            }
            const message = {
              senderId: userId, // 사용자 ID로 변경
              receiverId: receiverId, // 수신자 ID 추가
              content: messageContent,
              chatRoomId: chatRoomId,
            };
            stompClient.send(
              "/app/chat.sendMessage",
              {},
              JSON.stringify(message),
            );

            document.getElementById("msg").value = "";
          }

          socket.onclose = function (event) {
            console.log("WebSocket closed: ", event);
          };

          socket.onerror = function (event) {
            console.error("WebSocket error: ", event);
          };

          // 채팅 목록 불러오기 함수
          function loadChatRooms() {
            $.ajax({
              type: "GET",
              url: `/chat/chats?userId=${userId}`,
              success: function (chatRooms) {
                const chatList = $("#chatList");
                chatList.empty();
                chatRooms.forEach((chatRoom) => {
                  chatList.append(
                    `<li class="chat-list-box">
                        <div class="chat-list-sender">
                            <a href="/chat/room/${chatRoom.chatRoomId}?receiverId=${chatRoom.partnerId}">
                                ${chatRoom.partnerName}님과의 채팅
                            </a>
                        </div>
                        <div  class="post-link">
                            <a href="/board/view?id=${chatRoom.postId}">
								${chatRoom.postTitle} 게시글로 가기
							</a>
						</div>
    
    </li>`,
                  );
                });
              },
              error: function (error) {
                console.error("채팅 방 목록 로딩 중 오류 발생:", error);
              },
            });
          }

          // 페이지 로드 시 데이터 불러오기
          loadChatRooms();
          loadCurrentChatRoomInfo(chatRoomId);
        });
      </script>
    </div>
  </body>
</html>
