<!doctype html>
<html
  lang="en"
  layout:decorate="~{layouts/layout}"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  xmlns:th="http://www.thymeleaf.org"
>
  <head>
    <meta charset="UTF-8" />
    <title>Chat Room</title>
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.4.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  </head>
  <body>
    <div layout:fragment="content">
      <div>
        <div class="container">
          <div class="col-6">
            <label><b>채팅방</b></label>
          </div>
          <div>
            <div class="col" id="msgArea"></div>
            <div class="col-6">
              <div class="input-group mb-3">
                <input
                  aria-describedby="button-addon2"
                  aria-label="Recipient's username"
                  class="form-control"
                  id="msg"
                  type="text"
                />
                <div class="input-group-append">
                  <button
                    class="btn btn-outline-secondary"
                    id="button-send"
                    type="button"
                  >
                    전송
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script th:inline="javascript">
        $(document).ready(function () {
          function displayMessage(message) {
            var senderName = message.sender.nickname; // 보낸 사람의 닉네임
            var timestamp = new Date(message.timestamp);
            var options = { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Seoul' };
            var formattedTime = timestamp.toLocaleTimeString('ko-KR', options);

            var str = "<div class='col-6'>";
            str += "<div class='alert alert-info'>";
            str += "<b>" + senderName + " : " + message.content + " [" + formattedTime + "]</b>";
            str += "</div></div>";
            $("#msgArea").append(str);
          }

          function getPreviousChatMessages(chatRoomId) {
            fetch("/chat/messages/" + chatRoomId)
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((messages) => {
                if (Array.isArray(messages)) {
                  messages.forEach(displayMessage);
                } else {
                  throw new Error("Invalid response format");
                }
              })
              .catch((error) => {
                console.error("There has been a problem with your fetch operation:", error);
              });
          }

          const userId = /*[[${#authentication.principal.id}]]*/ "anonymous"; // 로그인한 사용자의 ID
          const chatRoomId = /*[[${chatRoomId}]]*/ "defaultRoom"; // 채팅방 ID
          const receiverId = /*[[${receiverId}]]*/ "defaultReceiver"; // 수신자 ID

          getPreviousChatMessages(chatRoomId);

          $("#button-send").on("click", (e) => {
            send();
          });

          const socket = new SockJS("/ws/chat");
          const stompClient = Stomp.over(socket);

          stompClient.connect({}, function (frame) {
            console.log("Connected: " + frame);

            stompClient.subscribe("/topic/public", function (messageOutput) {
              const message = JSON.parse(messageOutput.body);
              displayMessage(message);
            });
          });

          function send() {
            const message = {
              senderId: userId, // 사용자 ID로 변경
              receiverId: receiverId, // 수신자 ID 추가
              content: document.getElementById("msg").value,
              chatRoomId: chatRoomId,
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));

            document.getElementById("msg").value = "";
          }

          socket.onclose = function (event) {
            console.log("WebSocket closed: ", event);
          };

          socket.onerror = function (event) {
            console.error("WebSocket error: ", event);
          };
        });
      </script>

    </div>
  </body>
</html>
