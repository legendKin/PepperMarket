<!doctype html>
<html
        lang="en"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
  <meta charset="UTF-8" />
  <title>Pepper Market</title>
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <!-- 공통 CSS -->
  <th:block th:replace="~{fragments/common-styles::styles}"></th:block>
  <!-- CSS -->
  <th:block layout:fragment="css"></th:block>
</head>
<body>
<div th:replace="~{fragments/header::header}"></div>
<div class="main-content">
  <div class="container">
    <h2>My Chats</h2>
    <div class="chat-container">
      <div class="chat-list">
        <div id="chat-list-section">
          <ul id="chatList">
            <!-- 채팅 목록이 여기에 동적으로 추가됩니다 -->
          </ul>
        </div>
        <th:block th:insert="~{fragments/chatscripts::script}"></th:block>
      </div>

      <div class="chat-content" layout:fragment="chat-content"></div>
    </div>
  </div>
</div>
<div th:replace="~{fragments/footer::footer}"></div>
<!-- JQuery 스크립트를 body 끝부분에 추가하는 것이 좋습니다. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script th:inline="javascript">
  $(document).ready(function () {
    const userId = /*[[${#authentication.principal.id}]]*/ "anonymous"; // 로그인한 사용자의 ID

    function loadChatRooms() {
      $.ajax({
        type: "GET",
        url: `/chat/chats?userId=${userId}`,
        success: function (chatRooms) {
          const chatListContainer = $("#chatList");
          chatListContainer.empty();
          chatRooms.forEach((chatRoom) => {
            chatListContainer.append(
              `<div class="chat-list-box">
                  <div class="chat-list-sender">
                      <a href="#" class="chat-room-link" data-chat-room-id="${chatRoom.chatRoomId}" data-receiver-id="${chatRoom.partnerId}">
                          ${chatRoom.partnerName}님과의 채팅
                      </a>
                  </div>
                  <div class="post-link">
                      <a href="/board/view?id=${chatRoom.postId}">
                          ${chatRoom.postTitle} 게시글로 가기
                      </a>
                  </div>
              </div>`,
            );
          });

          $(".chat-room-link").on("click", function (e) {
            e.preventDefault();
            const chatRoomId = $(this).data("chat-room-id");
            const receiverId = $(this).data("receiver-id");
            window.location.href = `/chat/room/${chatRoomId}?receiverId=${receiverId}`;
          });
        },
        error: function (error) {
          console.error("채팅 방 목록 로딩 중 오류 발생:", error);
        },
      });
    }

    loadChatRooms();
  });
</script>
</body>
</html>
