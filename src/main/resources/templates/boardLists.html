<!doctype html>
<html
	lang="en" layout:decorate="~{layouts/layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org"
>
<head>
	<link rel="stylesheet" th:href="@{/css/boardcategories.css}"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<title>Pepper Market</title>
</head>
<body>
<div class="main-content" layout:fragment="content">
	<div class="wrapper">
		<div class="category-section">
			<div class="category-container">
				<div class="category-toggle-wrapper">
					<div class="category-toggle category-toggle1">
						<div class="category-toggle-content">
							<span class="filtername">카테고리</span>
							<img
								alt="화살표 아래 아이콘"
								src="https://ccimage.hellomarket.com/img/web/search/filter/white_arrow.svg"
							/>
						</div>
					</div>
					<div class="category-toggle category-toggle2">
						<div class="category-toggle-content">
							<span class="filtername">가격</span>
							<img
								alt="화살표 아래 아이콘"
								src="https://ccimage.hellomarket.com/img/web/search/filter/white_arrow.svg"
							/>
						</div>
					</div>
					<div class="isA-box">
						<div class="form-check is-available">
							<input
								class="form-check-input" type="checkbox" onchange="fetchBoardListData()"
								id="showCompleted"
							
							>
							<label class="form-check-label" for="showCompleted">
								판매 완료된 상품도 보기
							</label>
						</div>
					</div>
				</div>
				<div class="reset-filter ca">
					<a
						class="reset-button"
						th:href="@{/board/list(page=${page},searchKeyword=${searchKeyword}, searchCateID=)}"
					>
						<div class="reset-text">필터 초기화</div>
						<img
							alt="reset" class="reset-icon"
							src="https://ccimage.hellomarket.com/img/web/search/filter/refresh.svg"
						/>
					</a>
				</div>
			</div>
			
			<div class="category-list category-sublist1" style="display: none">
				<div class="category-list-container">
					<input type="text" id="searchKeyword" onkeyup="fetchBoardListData()">
					<div class = "category-item">
						<div class="category-name">카테고리</div>
					</div>
					
					<div class="category-count">
						<div class="form-check">
							<input
								class="form-check-input" type="radio" name="category" id="categoryAll" value=""
								onchange="fetchBoardListData()"
							>
							<label class="form-check-label" for="categoryAll">전체</label>
						</div>
						<div th:each="board, iterStat : ${categList}" class="form-check">
							<input
								class="form-check-input" type="radio" name="category" id="category${iterStat.index + 1}"
								th:value="${iterStat.index + 1}" onchange="fetchBoardListData()"
							>
							<label
								class="form-check-label" th:for="'category' + ${iterStat.index + 1}"
								th:text="${board} + ' (' + (${categoryPostCounts[iterStat.index + 1]} ?: 0) + ')'"
							></label>
						</div>
					</div>
				</div>
			</div>
			<div class="category-list category-sublist2" style="display: none">
				<div class="price-filter">
					<input
						class="min-price"
						placeholder="최저금액"
						type="text"
						value=""
					/>
					<div class="price-divider">원 부터~ &nbsp;</div>
					<input
						class="max-price"
						placeholder="최고금액"
						type="text"
						value=""
					/>
					<div class="price-divider">원 까지</div>
					<button class="apply-button">적용하기</button>
				</div>
			</div>
		
		</div>
		
		<div class="product-section">
			<div class="product-count">
				<div class="product-count-left">
					<h2><span th:text="${categNow}"></span></h2>
					<span class="count-text"><span th:text="${list.getTotalElements()}"></span>개의 상품이 있습니다.</span>
				</div>
				<div class="recommendation">
					<div class="recommendation-text">추천순</div>
					<img
						alt="정렬 아이콘" class="sort-icon"
						src="https://ccimage.hellomarket.com/img/web/search/itemList/ico_sort.png"
					/>
				</div>
			</div>
			<div id="product-list" th:fragment="content">
				<div class="product-album py-5 bg-light">
					<div class="container">
						<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
							<!-- 반복되는 상품 항목을 표시하는 코드 -->
							<div class="col" th:each="board : ${list}">
								<div class="card shadow-sm">
									<!-- 상품 이미지 및 정보 표시 -->
									<a
										th:classappend="${board.status != 3 ? 'available' : 'unavailable'}"
										th:href="@{/board/view(id=${board.id})}"
									>거래 완료</a>
									<a th:href="@{/board/view(id=${board.id})}">
										<img
											alt="상품이미지" class="card-img-top goods-img" height="300"
											onerror="this.src='/files/default.png'" th:src="${board.filepath}"
											weight="225"
											width="100%"
										/>
									</a>
									<div class="card-body card-box">
										<div class="card-cate">
											<p th:text="${board.categName}"></p>
										</div>
										<a
											class="card-t" th:href="@{/board/view(id=${board.id})}"
											th:text="${board.title}"
										>제목</a>
										<span class="card-price" th:text="${board.getFormattedPrice()} + '원'"></span>
										<div class="card-bottom">
											<th:block th:unless="${board.writer != loggedUserId}">
												<button
													class="btn btn-sm btn-outline-secondary edit-button" type="button"
												>
													<a th:href="@{/board/modify/{id}(id=${board.id})}">Edit</a></button>
											</th:block>
											<th:block th:if="${board.writer != loggedUserId}">
												<button
													class="btn btn-sm btn-outline-secondary edit-button"
													style="visibility: hidden"
													type="button"
												>Edit
												</button>
											</th:block>
											<small class="text-muted" th:text="${board.timeAgo}">timeago</small>
											<div class="like-section">
												<button onclick="likePost(${board.id})">좋아요</button>
												<span th:text="${board.likes}">0</span> Likes
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				
				<nav aria-label="Page navigation">
				<ul class="pagination">
					<!-- Previous button -->
					<li class="page-item" th:classappend="${nowPage == 1} ? 'disabled'">
						<a
							aria-label="Previous" class="page-link"
							th:href="@{/board/list(page=${startPage - 1}, searchKeyword=${searchKeyword}, searchCateID=${searchCateID})}"
						>
							<span aria-hidden="true">&laquo;</span>
						</a>
					</li>
					<!-- Page numbers -->
					<th:block th:each="page : ${#numbers.sequence(startPage, endPage)}">
						<li class="page-item" th:classappend="${page == nowPage} ? 'active'" th:if="${page > 0}">
							<a
								class="page-link"
								th:href="@{/board/list(page=${page-1}, searchKeyword=${searchKeyword}, searchCateID=${searchCateID})}"
								th:text="${page}"
							></a>
						</li>
					</th:block>
					<!-- Next button -->
					<li class="page-item" th:classappend="${nowPage == totalPage} ? 'disabled'">
						<a
							aria-label="Next" class="page-link"
							th:href="@{/board/list(page=${endPage + 1}, searchKeyword=${searchKeyword}, searchCateID=${searchCateID})}"
						>
							<span aria-hidden="true">&raquo;</span>
						</a>
					</li>
				</ul>
			</nav>
			</div>
		</div>
	</div>
	<script>
		function getCurrentCategoryId() {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get("searchCateID");
		}
		
		function applyStyleToSelectedCategory() {
			const currentCategoryId = getCurrentCategoryId();
			let selectedCategory = null;
			
			if (currentCategoryId !== null) {
				selectedCategory = document.querySelector(".category" + currentCategoryId);
				selectedCategoryTab = document.querySelector(".category-toggle");
			}
			
			if (selectedCategory !== null) {
				selectedCategory.style.color = "red";
				selectedCategoryTab.style.backgroundColor = "red";
				selectedCategoryTab.style.color = "white";
			}
		}
		
		
		function toggleCategory(sublistClass) {
			const sublists = [".category-sublist1", ".category-sublist2", ".category-sublist3"];
			sublists.forEach(sublist => {
				if (sublist === sublistClass) {
					$(sublist).slideToggle();
				} else {
					$(sublist).slideUp();
				}
			});
		}
		
		$(".category-toggle1").click(function () {
			toggleCategory(".category-sublist1");
		});
		$(".category-toggle2").click(function () {
			toggleCategory(".category-sublist2");
		});
		$(".category-toggle3").click(function () {
			toggleCategory(".category-sublist3");
		});
		
		window.onload = function () {
			applyStyleToSelectedCategory();
		};
	
	
	</script>
	<script>
		function fetchBoardListData() {
			var showCompleted = document.getElementById('showCompleted').checked;
			var searchCateID = $('input[name="category"]:checked').val();
			var searchKeyword = document.getElementById('searchKeyword').value;
			
			$.ajax({
				url: '/board/list',
				type: 'GET',
				data: {
					searchKeyword: searchKeyword,
					searchCateID: searchCateID,
					showCompleted: showCompleted,
					ajax: true // Ajax 요청임을 나타내는 매개변수 추가
				},
				success: function (response) {
					$('#product-list').html(response);
				},
				error: function (error) {
					console.error('Error fetching board list data:', error);
				}
			});
		}
	
	</script>


</div>


</body>
</html>
