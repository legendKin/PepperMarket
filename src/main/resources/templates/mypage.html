<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/mypagelayout}"
>
  <head>
    <meta charset="UTF-8" />
    <title>마이 페이지</title>
    <link rel="stylesheet" th:href="@{/css/mypage.css}" />
  </head>
  <body>
    <div layout:fragment="content">
      <div class="content-box">
        <div class="stack-1">
          <div class="username-box">
            <p><span th:text="${user.nickname}"></span>님의 페이지</p>
          </div>
        </div>
        <div class="stack-2">
          <div class="user-info">
            <div class="stack-2-title">
              <i class="fas fa-user"></i> UserInfo
            </div>
            <div class="user-info-box">
              <div class="user-profile-pic">
                <div class="user-profile-pic-img">
                  <img th:src="@{${user.profilePicPath}}" />
                </div>
                <div
                  class="user-profile-change-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#profile-photo-modify-modal"
                >
                  <i class="far fa-edit"></i>
                </div>
              </div>
              <div class="user-nickname">
                <span th:text="${user.nickname}"></span>
              </div>
              <div class="user-email">
                <span th:text="${user.email}"></span>
              </div>
            </div>
            <div class="user-info-modify-box">
              <div class="modify-nickname-box">
                <button
                  type="button"
                  class="btn btn-primary modify-nickname"
                  data-bs-toggle="modal"
                  data-bs-target="#nickname-modify-modal"
                >
                  <i class="fas fa fa-plus"></i> 내 닉네임 수정
                </button>
              </div>
              <div class="modify-password-box">
                <button
                  type="button"
                  class="btn btn-primary modify-nickname"
                  data-bs-toggle="modal"
                  data-bs-target="#password-modify-modal"
                >
                  <i class="far fa-edit"></i>
                  비밀번호 변경
                </button>
              </div>
            </div>
          </div>
          <div class="user-detail"></div>
        </div>
        <div class="stack-3">
          <div class="post-list">판매 내역</div>
          <div class="liked-list">찜 목록</div>
          <div class="comment">후기</div>
        </div>
      </div>
      <div class="modals">
        <div class="user-info-modify-modal">
          <div
            class="modal fade"
            id="nickname-modify-modal"
            tabindex="-1"
            aria-labelledby="nicknameModifyModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <form id="nickname-form">
                  <div class="modal-body">
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                    <div class="mb-3 mt-3">
                      <label for="nickname" class="form-label"
                        >내 닉네임 수정</label
                      >
                      <input
                        type="text"
                        class="form-control mt-3"
                        id="nickname"
                        name="nickname"
                        th:value="${user.nickname}"
                        required
                      />
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Close
                    </button>
                    <button type="submit" class="btn btn-primary">
                      Save changes
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div
            class="modal fade"
            id="password-modify-modal"
            tabindex="-1"
            aria-labelledby="passwordModifyModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div th:if="${user.provider}==null">
                  <form id="password-change-form">
                    <div class="modal-body">
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      ></button>

                      <div class="form-floating mb-3">
                        <input
                          type="password"
                          id="current-password"
                          name="current-password"
                          class="form-control"
                          placeholder="password"
                          required
                        />
                        <label for="current-password">현재 비밀번호</label>
                      </div>
                      <div class="form-floating mb-3">
                        <input
                          type="password"
                          id="new-password"
                          name="new-password"
                          class="form-control"
                          placeholder="password"
                          required
                        />
                        <label for="new-password">새 비밀번호</label>
                      </div>
                      <div class="form-floating mb-3">
                        <input
                          type="password"
                          id="confirm-password"
                          name="confirm-password"
                          class="form-control"
                          placeholder="password"
                          required
                        />
                        <label for="confirm-password">새 비밀번호 확인</label>
                      </div>
                    </div>

                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Close
                      </button>
                      <button type="submit" class="btn btn-primary">
                        Save changes
                      </button>
                    </div>
                  </form>
                </div>
                <div th:if="${user.provider} != null">
                  <div class="modal-body">
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                    <p class="mt-3">소셜계정 가입 회원은 변경할 수 없습니다.</p>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="modal fade"
            id="profile-photo-modify-modal"
            tabindex="-1"
            aria-labelledby="profilePhotoModifyModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-body">
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                  <form id="profile-photo-form" enctype="multipart/form-data">
                    <div class="mb-3 mt-3">
                      <label for="profile-photo" class="form-label"
                        >프로필 사진 선택</label
                      >
                      <input
                        type="file"
                        class="form-control mt-3"
                        id="profile-photo"
                        name="profile-photo"
                        accept="image/*"
                        required
                      />
                    </div>
                    <button type="submit" class="btn btn-primary">
                      프로필 사진 변경
                    </button>
                  </form>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 성공 모달 -->
        <div id="successModal" class="modal fade" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-body">
                <p>Profile updated successfully.</p>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-primary"
                  data-bs-dismiss="modal"
                >
                  확인
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- 오류 모달 -->
        <div id="errorModal" class="modal fade" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-body">
                <p>비밀번호 변경 중 오류가 발생했습니다.</p>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-primary"
                  data-bs-dismiss="modal"
                >
                  확인
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script th:inline="javascript">
        // API URL 설정

        // 프로필 변경 팝업
        $(document).ready(function () {
          $("#nickname-form").submit(function (event) {
            event.preventDefault(); // 기본 폼 제출 동작을 막음

            const nickname = $("#nickname").val();

            $.ajax({
              type: "POST",
              url: "/mypage/change-nickname",
              data: { nickname: nickname },
              success: function () {
                $("#nickname-modify-modal").modal("hide");
                $("#nicknameDisplay").text(nickname);

                $("#successModal").modal("show"); // 성공 모달 표시
              },
              error: function () {
                $("#nickname-modify-modal").modal("hide");

                $("#errorModal").modal("show"); // 오류 모달 표시
                $("#errorModal .modal-content p").text(
                  "닉네임 변경 중 오류가 발생했습니다.",
                );
              },
            });
          });
          $("#password-change-form").submit(function (event) {
            event.preventDefault(); // 기본 폼 제출 동작을 막음

            $.ajax({
              type: "GET",
              url: "/mypage/is-social-login",
              success: function (isSocialLogin) {
                if (isSocialLogin) {
                  $("#errorModal .modal-content p").text(
                    "소셜 로그인 계정은 비밀번호를 변경할 수 없습니다.",
                  );
                  $("#errorModal").modal("show");
                } else {
                  // 소셜 로그인 사용자가 아니면 비밀번호 변경 요청 진행
                  const currentPassword = $("#current-password").val();
                  const newPassword = $("#new-password").val();
                  const confirmPassword = $("#confirm-password").val();

                  if (newPassword !== confirmPassword) {
                    alert("새 비밀번호가 일치하지 않습니다.");
                    return;
                  }

                  $.ajax({
                    type: "POST",
                    url: "/mypage/change-password",
                    data: JSON.stringify({
                      currentPassword: currentPassword,
                      newPassword: newPassword,
                    }),
                    contentType: "application/json",
                    success: function () {
                      $("#password-modify-modal").modal("hide");
                      $("#successModal").modal("show"); // 성공 모달 표시
                    },
                    error: function (xhr, status, error) {
                      $("#password-modify-modal").modal("hide");
                      $("#errorModal .modal-content p").text(
                        "오류가 발생했습니다: " + xhr.responseText,
                      );
                      $("#errorModal").modal("show"); // 오류 모달 표시
                    },
                  });
                }
              },
              error: function () {
                $("#errorModal .modal-content p").text(
                  "소셜 로그인 상태를 확인하는 중 오류가 발생했습니다.",
                );
                $("#errorModal").modal("show");
              },
            });
          });

          $("#name-form").submit(function (event) {
            event.preventDefault(); // 기본 폼 제출 동작을 막음

            const name = $("#name").val();

            $.ajax({
              type: "POST",
              url: "/mypage/change-name",
              data: { name: name },
              success: function () {
                $("#successModal").modal("show"); // 모달 표시
                $("#nameDisplay").text(name);

                setTimeout(function () {
                  $("#successModal").modal("hide");
                }, 1000);
              },
              error: function () {
                alert("이름 변경 중 오류가 발생했습니다.");
              },
            });
          });

          $("#profile-photo-form").submit(function (event) {
            event.preventDefault(); // 기본 폼 제출 동작을 막음

            var formData = new FormData();
            formData.append("file", $("#profile-photo")[0].files[0]); // 파일 업로드 부분

            $.ajax({
              type: "POST",
              url: "/mypage/change-profilepic",
              data: formData,
              processData: false,
              contentType: false,
              success: function (response) {
                $("#profile-photo-modify-modal").modal("hide");
                $("#successModal .modal-content p").text(response); // 성공 메시지 표시
                $("#successModal").modal("show");
              },
              error: function (xhr, status, error) {
                $("#profile-photo-modify-modal").modal("hide");
                $("#errorModal .modal-content p").text(xhr.responseText); // 오류 메시지 표시
                $("#errorModal").modal("show");
              },
            });
          });

          $("#birthdate-form").submit(function (event) {
            event.preventDefault(); // 기본 폼 제출 동작을 막음

            const birthdate = $("#birthdate").val();

            $.ajax({
              type: "POST",
              url: "/mypage/change-birthdate",
              data: { birthdate: birthdate },
              success: function () {
                $("#successModal").modal("show"); // 모달 표시
                $("#birthdateDisplay").text(birthdate);

                setTimeout(function () {
                  $("#successModal").modal("hide");
                }, 1000);
              },
              error: function () {
                alert("생년월일 변경 중 오류가 발생했습니다.");
              },
            });
          });
        });

        // 성공 모달의 확인 버튼 클릭 시 모달 닫기
        $("#successModal .btn-primary").click(function () {
          $("#successModal").modal("hide");
        });

        // 오류 모달의 확인 버튼 클릭 시 모달 닫기
        $("#errorModal .btn-primary").click(function () {
          $("#errorModal").modal("hide");
        });

        // 성공 모달이 숨겨질 때 페이지 새로고침
        $("#successModal").on("hidden.bs.modal", function () {
          location.reload();
        });

        // 오류 모달이 숨겨질 때 페이지 새로고침
        $("#errorModal").on("hidden.bs.modal", function () {
          location.reload();
        });
      </script>
    </div>
  </body>
</html>
