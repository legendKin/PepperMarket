<!doctype html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layouts/mypagelayout}"
>
<head>
  <meta charset="UTF-8" />
  <title>내 페이지</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div layout:fragment="content">
  <h1>내 페이지</h1>
  <p>닉네임: <span th:text="${user.nickname}"></span></p>
  <p>이메일: <span th:text="${user.email}"></span></p>
  <p>소셜 아이디: <span th:text="${user.socialId}"></span></p>
  <p>제공자: <span th:text="${user.provider}"></span></p>
  <p>제공자 아이디: <span th:text="${user.providerId}"></span></p>
	<p>프로필 사진: <img th:src="@{${user.profilePictureUrl}}" alt="Profile Picture"></p>
  <!-- 사용자 ID를 숨겨진 필드로 추가 -->
  <input id="userId" th:value="${user.id}" type="hidden" />

  <!-- 프로필 정보 변경 섹션 -->
  <section id="profile-info-section">
    <h2>프로필 정보 변경</h2>
    <form
            enctype="multipart/form-data"
            method="post"
            th:action="@{/mypage/change-profile-info}"
    >
      <label for="file">프로필 사진:</label>
      <img
              alt="프사"
              class="profile-img-mypage"
              th:src="@{${user.profilePictureUrl}}"
      />
      <input id="file" name="file" type="file" /><br />

      <label for="nickname">닉네임:</label>
      <input
              id="nickname"
              name="nickname"
              th:value="${user.nickname}"
              type="text"
      /><br />

      <label for="email">이메일:</label>
      <input
              id="email"
              name="email"
              th:value="${user.email}"
              type="email"
              readonly
      /><br />

      <label for="name">이름:</label> <!-- *추가된 필드* -->
      <input
              id="name"
              name="name"
              th:value="${user.name}"
              type="text"
      /><br />
      <label for="birthdate">생년월일:</label> <!-- *** 생년월일 필드 추가 -->
      <input type="date" name="birthdate" id="birthdate" th:value="${#dates.format(user.birthdate, 'yyyy-MM-dd')}"><br>

      <button type="submit">프로필 정보 변경</button>
    </form>
  </section>

  <!-- 키워드 관리 섹션 -->
  <section id="keywords-section">
	  <label for="new-keyword">키워드 목록</label>
    <input id="new-keyword" placeholder="새 키워드를 입력하세요" type="text" />
    <button onclick="addKeyword()">추가</button>
    <ul id="keyword-list"></ul>
  </section>

  <!-- 알림 섹션 -->
  <section id="notifications-section">
    <h2>알림 목록</h2>
	  <div th:text="${unreadNotificationCount}">
	  
	  </div>
	  <ul id="notification-list"></ul>
  
  </section>

  <!-- 채팅 목록 섹션 -->
  <section id="chat-list-section">
    <h2>My Chats</h2>
    <ul id="chatList">
      <!-- 채팅 목록이 여기에 동적으로 추가됩니다 -->
    </ul>
  </section>

  <!-- *최근 본 상품 목록 섹션* -->
  <section id="recent-viewed-posts-section">
    <h2>최근 본 상품 목록</h2>
    <ul id="recentViewedPostsList">
      <!-- 최근 본 상품 목록이 여기에 동적으로 추가됩니다 -->
    </ul>
  </section>

  <script th:inline="javascript">
    // API URL 설정
    const API_BASE_URL = "/keywords";
    const NOTIFICATION_API_URL = "/notifications";
    const RECENT_VIEWED_POSTS_API_URL = '/recent-viewed-posts'; // *

    // 키워드 추가 함수
    function addKeyword() {
        const keyword = $('#new-keyword').val();
        const userId = $('#userId').val(); // 사용자 ID 가져오기
        $.ajax({
            type: 'POST',
            url: API_BASE_URL,
            contentType: 'application/json',
            data: JSON.stringify({ keyword: keyword, userId: userId }),
            success: function() {
                loadKeywords();
                $('#new-keyword').val('');
            },
            error: function(error) {
                console.error('키워드 추가 중 오류 발생:', error);
            }
        });
    }

    // 키워드 삭제 함수
    function deleteKeyword(id) {
        $.ajax({
            type: 'DELETE',
            url: `${API_BASE_URL}/${id}`,
            success: function() {
                loadKeywords();
            },
            error: function(error) {
                console.error('키워드 삭제 중 오류 발생:', error);
            }
        });
    }

    // 키워드 목록 불러오기 함수
    function loadKeywords() {
        $.ajax({
            type: 'GET',
            url: API_BASE_URL,
            success: function(keywords) {
                const keywordList = $('#keyword-list');
                keywordList.empty();
                keywords.forEach(keyword => {
                    keywordList.append(`<li>${keyword.keyword} <button onclick="deleteKeyword(${keyword.id})">삭제</button></li>`);
                });
            },
            error: function(error) {
                console.error('키워드 목록 불러오기 중 오류 발생:', error);
            }
        });
    }

    // 알림 목록 불러오기 함수
    function loadNotifications() {
        const userId = $('#userId').val(); // 사용자 ID 가져오기
        console.log('사용자 ID의 알림 로딩 중:', userId); // 디버깅 로그 추가

        $.ajax({
            type: 'GET',
            url: `${NOTIFICATION_API_URL}?userId=${userId}`,
            success: function(notifications) {
                console.log('알림 가져옴:', notifications); // 디버깅 로그 추가

              const notificationList = $("#notification-list");
              notificationList.empty();
              notifications.forEach((notification) => {
                const readStatus = notification.read ? "읽음" : "읽지 않음";
                notificationList.append(
                  `<li><a href="board/view?id=${notification.board.id}">${notification.message} - ${readStatus} <button onclick="markAsRead(${notification.id})">읽음 표시</button></a></li>`,
                );
              });
            },
            
            error: function(error) {
                console.error('알림 목록 불러오기 중 오류 발생:', error);
            }
        });
    }

    // 알림 읽음 표시 함수
    function markAsRead(id) {
        $.ajax({
            type: 'POST',
            url: `${NOTIFICATION_API_URL}/${id}/read`,
            success: function() {
                loadNotifications();
            },
            error: function(error) {
                console.error('알림 읽음 표시 중 오류 발생:', error);
            }
        });
    }

    // 채팅 목록 불러오기 함수
    function loadChatRooms() {
        const userId = $('#userId').val(); // 사용자 ID 가져오기
        $.ajax({
            type: 'GET',
            url: `/chat/chats?userId=${userId}`,
            success: function(chatRooms) {
                const chatList = $('#chatList');
                chatList.empty();
                chatRooms.forEach(chatRoom => {
                    chatList.append(`<li> ${chatRoom.partnerName}님의 메세지 - <a href="/chat/room/${chatRoom.chatRoomId}?receiverId=${userId}">채팅방으로 이동</a></li>`);
                });
            },
            error: function(error) {
                console.error('채팅 방 목록 로딩 중 오류 발생:',  error);
            }
        });
    }

    // 페이지 로드 시 데이터 불러오기
    $(document).ready(function () {
      loadKeywords();
      loadNotifications();
      loadChatRooms();
      loadRecentViewedPosts(); // *
    });
  </script>
</div>
</body>
</html>
